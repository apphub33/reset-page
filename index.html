<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reset password</title>
  <style>
    :root { --pri:#8b7cf6; --bg:#fff7fb; --err:#c62828; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; background:#fff; }
    .wrap { max-width: 560px; margin: 0 auto; padding: 28px 16px 48px; }
    h1 { margin: 0 0 14px; font-size: 34px; line-height:1.15; }
    .msg { color: #555; margin: 6px 0 18px; }
    .err { color: var(--err); font-weight: 600; margin: 8px 0 16px; white-space: pre-wrap; }
    .row { display:flex; gap:10px; align-items:center; margin: 10px 0; }
    input[type=password], input[type=text] {
      flex:1; padding:14px 12px; font-size:16px; border:1px solid #ddd; border-radius:12px; outline:none;
    }
    button {
      display:inline-block; width:100%; border:0; padding:14px 16px; font-size:16px; border-radius:14px;
      background:var(--pri); color:#fff; cursor:pointer;
    }
    button[disabled] { opacity:.6; cursor:default; }
    .eye { width:48px; height:48px; border-radius:12px; border:1px solid #ddd; background:#f7f7f7; cursor:pointer; }
    .subtle { margin-top:12px; display:inline-block; text-decoration:none; color:#333; background:#eee; padding:10px 14px; border-radius:12px; }
    .hide { display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Reset password</h1>
    <div id="status" class="msg">Preparing‚Ä¶</div>
    <div id="error" class="err hide"></div>

    <div id="form" class="hide">
      <div class="row">
        <input id="pw1" type="password" placeholder="New password" autocomplete="new-password" />
        <button class="eye" type="button" id="t1">üëÅÔ∏è</button>
      </div>
      <div class="row">
        <input id="pw2" type="password" placeholder="Confirm password" autocomplete="new-password" />
        <button class="eye" type="button" id="t2">üëÅÔ∏è</button>
      </div>
      <button id="submit">Update password</button>
      <a class="subtle" href="bizchat://setup">Return to App</a>
    </div>

    <div id="done" class="hide">
      <div class="msg">Password updated. You can close this tab and return to the app.</div>
      <a class="subtle" href="bizchat://setup">Return to App</a>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // üîí Your project (hard-coded as requested)
    const SB_URL  = 'https://dlecrwuwsnvtykcyvkme.supabase.co';
    const SB_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsZWNyd3V3c252dHlrY3l2a21lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2MDYxODQsImV4cCI6MjA3NTE4MjE4NH0.sZ-vk_F0-TsjF2Qr76W7drOzf0CQo5qBSHFSj_4BdUw';

    const sb = createClient(SB_URL, SB_ANON, { auth: { persistSession: false } });

    const $ = (id) => document.getElementById(id);
    const status = $('status'), err = $('error'), form = $('form'), done = $('done');
    const pw1 = $('pw1'), pw2 = $('pw2'), submit = $('submit');

    // Show/hide helpers
    const show = (el) => el.classList.remove('hide');
    const hide = (el) => el.classList.add('hide');
    const setErr = (m) => { if (m) { err.textContent = m; show(err); } else { err.textContent = ''; hide(err); } };
    const setStatus = (m) => status.textContent = m || '';

    // Parse helpers
    const qs = new URLSearchParams(location.search);
    const hs = new URLSearchParams(location.hash.replace(/^#/, ''));

    const token_hash = qs.get('token_hash');
    const type = (qs.get('type') || '').toLowerCase();
    const access_token = hs.get('access_token');
    const refresh_token = hs.get('refresh_token');

    // Boot: establish an auth session exactly once
    async function boot() {
      try {
        // Case 1: Newer recovery links: ?token_hash=...&type=recovery
        if (token_hash) {
          setStatus('Verifying reset link‚Ä¶');
          const { data, error } = await sb.auth.verifyOtp({ type: 'recovery', token_hash });
          if (error) throw error;
          setStatus('Link verified. Enter your new password.');
          show(form);
          return;
        }

        // Case 2: Fragment tokens (older behavior): #access_token=‚Ä¶&refresh_token=‚Ä¶
        if (access_token && refresh_token) {
          setStatus('Restoring session‚Ä¶');
          const { error } = await sb.auth.setSession({ access_token, refresh_token });
          if (error) throw error;
          setStatus('Session ready. Enter your new password.');
          show(form);
          return;
        }

        // No usable tokens ‚Üí show guidance
        setErr('Could not initialize recovery session. Open the link directly from the email again.');
        setStatus('');
      } catch (e) {
        setErr(e?.message || String(e));
        setStatus('');
      }
    }

    // Toggle eyes
    $('t1').onclick = () => pw1.type = (pw1.type === 'password' ? 'text' : 'password');
    $('t2').onclick = () => pw2.type = (pw2.type === 'password' ? 'text' : 'password');

    // Update password
    submit.onclick = async () => {
      setErr('');
      const a = pw1.value.trim(), b = pw2.value.trim();
      if (a.length < 6) { setErr('Password must be at least 6 characters.'); return; }
      if (a !== b) { setErr('Passwords do not match.'); return; }
      submit.disabled = true; setStatus('Updating‚Ä¶');
      try {
        const { error } = await sb.auth.updateUser({ password: a });
        if (error) throw error;
        hide(form); setStatus(''); show(done);
      } catch (e) {
        setErr(e?.message || String(e));
      } finally {
        submit.disabled = false; setStatus('');
      }
    };

    boot();
  </script>
</body>
</html>

